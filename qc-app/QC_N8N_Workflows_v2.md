# QC Scenario Planning - n8n Workflow Architecture v2.0

**Date:** 2025-01-15
**Purpose:** Complete n8n automation architecture for QC Scenario Planning
**Database:** PostgreSQL/Supabase with UUID primary keys
**Architecture:** RESTful API + Scheduled Jobs + Event-Driven Notifications

---

## ğŸ“‹ TABLE OF CONTENTS

1. [Workflow Overview](#workflow-overview)
2. [Core CRUD Workflows](#core-crud-workflows)
3. [Validation & Business Rules](#validation--business-rules)
4. [Scheduled Automation Workflows](#scheduled-automation-workflows)
5. [Reporting Workflows](#reporting-workflows)
6. [Notification Workflows](#notification-workflows)
7. [Reusable Sub-Workflows](#reusable-sub-workflows)
8. [Example Node Configurations](#example-node-configurations)
9. [Error Handling & Retry Strategy](#error-handling--retry-strategy)
10. [Security Best Practices](#security-best-practices)
11. [Acceptance Criteria Checklist](#acceptance-criteria-checklist)

---

## ğŸ¯ WORKFLOW OVERVIEW

### Workflow Categories

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QC n8n Workflows                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“¥ CRUD Workflows (Webhook-triggered REST API)             â”‚
â”‚     â”œâ”€ WF-001: Create Task                                 â”‚
â”‚     â”œâ”€ WF-002: Update Task                                 â”‚
â”‚     â”œâ”€ WF-003: Soft Delete/Cancel Task                     â”‚
â”‚     â”œâ”€ WF-004: Restore Task                                â”‚
â”‚     â”œâ”€ WF-005: Create Project                              â”‚
â”‚     â”œâ”€ WF-006: Update Project                              â”‚
â”‚     â”œâ”€ WF-007: Create Resource                             â”‚
â”‚     â””â”€ WF-008: Update Resource                             â”‚
â”‚                                                             â”‚
â”‚  ğŸ”„ Scheduled Workflows (Time-triggered)                    â”‚
â”‚     â”œâ”€ WF-009: Daily Resource Utilization Check            â”‚
â”‚     â”œâ”€ WF-010: Weekly Project Health Report                â”‚
â”‚     â”œâ”€ WF-011: Daily Deadline Reminder                     â”‚
â”‚     â””â”€ WF-012: Nightly Database Maintenance                â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š Reporting Workflows (On-demand + Scheduled)             â”‚
â”‚     â”œâ”€ WF-013: Generate Project Status Report (Excel)      â”‚
â”‚     â”œâ”€ WF-014: Generate Resource Utilization Report (PDF)  â”‚
â”‚     â”œâ”€ WF-015: Generate Task List Export (CSV)             â”‚
â”‚     â””â”€ WF-016: Generate Dashboard Snapshot (Excel + PDF)   â”‚
â”‚                                                             â”‚
â”‚  ğŸ”” Notification Workflows (Event-triggered)                â”‚
â”‚     â”œâ”€ WF-017: Resource Overload Alert                     â”‚
â”‚     â”œâ”€ WF-018: Task Deadline Alert                         â”‚
â”‚     â”œâ”€ WF-019: Project At Risk Alert                       â”‚
â”‚     â””â”€ WF-020: Validation Failure Notification             â”‚
â”‚                                                             â”‚
â”‚  ğŸ”§ Reusable Sub-Workflows (Called by other workflows)      â”‚
â”‚     â”œâ”€ SW-001: Validate Task Input                         â”‚
â”‚     â”œâ”€ SW-002: Write Audit Log                             â”‚
â”‚     â”œâ”€ SW-003: Check Resource Availability                 â”‚
â”‚     â”œâ”€ SW-004: Validate Status Transition                  â”‚
â”‚     â”œâ”€ SW-005: Calculate Project Metrics                   â”‚
â”‚     â””â”€ SW-006: Send Email Notification                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Total Workflows: 26
- **CRUD:** 8 workflows
- **Scheduled:** 4 workflows
- **Reporting:** 4 workflows
- **Notifications:** 4 workflows
- **Sub-Workflows:** 6 workflows

---

## ğŸ“¥ CORE CRUD WORKFLOWS

### **WF-001: Create Task**

**Trigger:** Webhook (POST /api/tasks)
**Purpose:** Create new task with validation and audit logging

#### Input Payload Schema

```json
{
  "task_id": "TSK-007",
  "project_id": "PRJ-001",
  "task_name": "Implement authentication module",
  "status": "Backlog",
  "estimate_days": 3.0,
  "resource1_name": "Basel",
  "r1_estimate_hrs": 24.0,
  "r1_actual_hrs": 0.0,
  "resource2_name": null,
  "r2_estimate_hrs": 0.0,
  "r2_actual_hrs": 0.0,
  "deadline": "2025-02-15",
  "completed_date": null,
  "tags": ["backend", "security"],
  "notes": "Implement JWT-based auth with refresh tokens",
  "user_email": "manager@company.com"
}
```

#### Node Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhook Trigger                                             â”‚
â”‚    - Method: POST                                              â”‚
â”‚    - Path: /api/tasks                                          â”‚
â”‚    - Authentication: Header token                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Function: Validate Authentication                           â”‚
â”‚    - Check X-API-Key header                                    â”‚
â”‚    - Verify user_email in payload                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Execute Sub-Workflow: SW-001 (Validate Task Input)         â”‚
â”‚    - Check required fields                                     â”‚
â”‚    - Validate task_id format (TSK-XXX)                         â”‚
â”‚    - Validate status value                                     â”‚
â”‚    - Check positive hours                                      â”‚
â”‚    - Returns: {valid: true/false, errors: [...]}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. IF Node: Validation Failed?                                â”‚
â”‚    - If errors exist â†’ Execute WF-020 (Validation Failure)    â”‚
â”‚    - Return 400 Bad Request with error details                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (validation passed)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Postgres: Lookup Foreign Keys                              â”‚
â”‚    - Query: Get project UUID from project_id                  â”‚
â”‚    - Query: Get resource1 UUID from resource1_name            â”‚
â”‚    - Query: Get resource2 UUID from resource2_name (if set)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. IF Node: Foreign Keys Not Found?                           â”‚
â”‚    - If project not found â†’ Return 404 Project Not Found      â”‚
â”‚    - If resource not found â†’ Return 404 Resource Not Found    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (foreign keys exist)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Postgres: Check Uniqueness                                 â”‚
â”‚    - Query: Check if task_id already exists                   â”‚
â”‚    - WHERE task_id = ? AND is_deleted = FALSE                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. IF Node: Task ID Already Exists?                           â”‚
â”‚    - Return 409 Conflict "Task ID already exists"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (unique)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Execute Sub-Workflow: SW-003 (Check Resource Availability) â”‚
â”‚    - Calculate current resource allocation                     â”‚
â”‚    - Check if adding task exceeds capacity                     â”‚
â”‚    - Returns: {available: true/false, warning: "..."}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Function: Generate UUID                                    â”‚
â”‚     - Generate UUID for new task                               â”‚
â”‚     - Generate UUID for audit log                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. Postgres: INSERT Task                                      â”‚
â”‚     - INSERT INTO tasks (id, task_id, project_id, ...)        â”‚
â”‚     - VALUES (?, ?, ?, ...)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. Execute Sub-Workflow: SW-002 (Write Audit Log)            â”‚
â”‚     - action: 'CREATE'                                         â”‚
â”‚     - entity_name: 'tasks'                                     â”‚
â”‚     - entity_id: <task_uuid>                                   â”‚
â”‚     - before_json: null                                        â”‚
â”‚     - after_json: <full task record>                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. IF Node: Resource Over Capacity Warning?                  â”‚
â”‚     - If warning exists â†’ Execute WF-017 (Resource Alert)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. Postgres: Query Created Task with Metrics                 â”‚
â”‚     - SELECT * FROM v_tasks_with_metrics WHERE id = ?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. Function: Format Response                                  â”‚
â”‚     - Build success response with task data                    â”‚
â”‚     - Include warnings if any                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 16. Respond to Webhook                                         â”‚
â”‚     - Status: 201 Created                                      â”‚
â”‚     - Body: {success: true, data: {...}, warnings: [...]}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Example Response

```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "task_id": "TSK-007",
    "project_id": "123e4567-e89b-12d3-a456-426614174000",
    "task_name": "Implement authentication module",
    "status": "Backlog",
    "estimate_days": 3.0,
    "estimate_hrs": 24.0,
    "total_estimate_hrs": 24.0,
    "total_actual_hrs": 0.0,
    "overall_completion_pct": 0.0,
    "deadline": "2025-02-15",
    "created_at": "2025-01-15T10:30:00Z"
  },
  "warnings": [
    "Resource 'Basel' utilization will be 95% after this task assignment"
  ]
}
```

---

### **WF-002: Update Task**

**Trigger:** Webhook (PATCH /api/tasks/:task_id)
**Purpose:** Update task with status transition validation and audit logging

#### Input Payload Schema

```json
{
  "task_id": "TSK-001",
  "updates": {
    "status": "In Progress",
    "r1_actual_hrs": 5.0,
    "notes": "Started work on mobile view implementation"
  },
  "user_email": "basel@company.com"
}
```

#### Node Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhook Trigger                                             â”‚
â”‚    - Method: PATCH                                             â”‚
â”‚    - Path: /api/tasks/:task_id                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Function: Validate Authentication                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Postgres: Fetch Current Task State                         â”‚
â”‚    - SELECT * FROM tasks WHERE task_id = ? AND is_deleted = F â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. IF Node: Task Not Found?                                   â”‚
â”‚    - Return 404 Not Found                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (task exists)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Function: Extract Changed Fields                            â”‚
â”‚    - Compare updates with current state                        â”‚
â”‚    - Build list of changed fields                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. IF Node: Status Changed?                                   â”‚
â”‚    - If yes â†’ Execute SW-004 (Validate Status Transition)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Execute Sub-Workflow: SW-004 (Validate Status Transition)  â”‚
â”‚    - Check if transition is allowed                            â”‚
â”‚    - Check required fields for transition                      â”‚
â”‚    - Example: Backlog â†’ In Progress (allowed)                 â”‚
â”‚    - Example: In Progress â†’ Done (requires completed_date)    â”‚
â”‚    - Returns: {allowed: true/false, errors: [...]}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. IF Node: Transition Not Allowed?                           â”‚
â”‚    - Return 400 Bad Request with validation errors            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (transition valid)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Function: Validate Update Fields                            â”‚
â”‚    - Check only allowed fields are being updated              â”‚
â”‚    - Read-only fields: estimate_hrs, total_estimate_hrs, etc. â”‚
â”‚    - Validate data types and constraints                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. IF Node: Updating Read-Only Fields?                       â”‚
â”‚     - Return 400 Bad Request "Cannot update derived fields"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. Postgres: UPDATE Task                                      â”‚
â”‚     - UPDATE tasks SET ... WHERE id = ?                        â”‚
â”‚     - Only update allowed fields from payload                  â”‚
â”‚     - Set updated_at = CURRENT_TIMESTAMP                       â”‚
â”‚     - Set updated_by = user_email                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. Execute Sub-Workflow: SW-002 (Write Audit Log)            â”‚
â”‚     - action: 'UPDATE'                                         â”‚
â”‚     - before_json: <old state>                                 â”‚
â”‚     - after_json: <new state>                                  â”‚
â”‚     - changed_fields: [list of changed field names]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. IF Node: Status Changed to Done?                          â”‚
â”‚     - If yes â†’ Trigger WF-019 (Check Project Status)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. Postgres: Query Updated Task with Metrics                 â”‚
â”‚     - SELECT * FROM v_tasks_with_metrics WHERE id = ?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. Respond to Webhook                                         â”‚
â”‚     - Status: 200 OK                                           â”‚
â”‚     - Body: {success: true, data: {...}}                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Example Response

```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "task_id": "TSK-001",
    "status": "In Progress",
    "r1_actual_hrs": 5.0,
    "overall_completion_pct": 12.5,
    "updated_at": "2025-01-15T14:30:00Z"
  },
  "changes": {
    "status": {
      "old": "Backlog",
      "new": "In Progress"
    },
    "r1_actual_hrs": {
      "old": 0.0,
      "new": 5.0
    }
  }
}
```

---

### **WF-003: Soft Delete/Cancel Task**

**Trigger:** Webhook (DELETE /api/tasks/:task_id)
**Purpose:** Soft delete task by setting status='Cancelled' and is_deleted=TRUE

#### Input Payload Schema

```json
{
  "task_id": "TSK-006",
  "reason": "Scope changed, no longer needed",
  "user_email": "manager@company.com"
}
```

#### Node Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhook Trigger (DELETE /api/tasks/:task_id)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Function: Validate Authentication                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Postgres: Fetch Current Task State                         â”‚
â”‚    - SELECT * FROM tasks WHERE task_id = ? AND is_deleted = F â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. IF Node: Task Not Found?                                   â”‚
â”‚    - Return 404 Not Found                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. IF Node: Task Already Cancelled/Deleted?                   â”‚
â”‚    - If status IN ('Cancelled', 'Done') â†’ Return 400          â”‚
â”‚    - "Cannot delete completed/cancelled task"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Postgres: Soft Delete Task                                 â”‚
â”‚    - UPDATE tasks SET                                          â”‚
â”‚      status = 'Cancelled',                                     â”‚
â”‚      is_deleted = TRUE,                                        â”‚
â”‚      deleted_at = CURRENT_TIMESTAMP,                           â”‚
â”‚      deleted_by = user_email                                   â”‚
â”‚    - WHERE id = ?                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Execute Sub-Workflow: SW-002 (Write Audit Log)             â”‚
â”‚    - action: 'DELETE'                                          â”‚
â”‚    - before_json: <old state>                                  â”‚
â”‚    - after_json: <new state with is_deleted=TRUE>             â”‚
â”‚    - metadata: {reason: "..."}                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Execute Sub-Workflow: SW-005 (Recalculate Project Metrics) â”‚
â”‚    - Project metrics will change due to removed task           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Respond to Webhook                                          â”‚
â”‚    - Status: 200 OK                                            â”‚
â”‚    - Body: {success: true, message: "Task cancelled"}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **WF-004: Restore Task**

**Trigger:** Webhook (POST /api/tasks/:task_id/restore)
**Purpose:** Restore a soft deleted task

#### Input Payload Schema

```json
{
  "task_id": "TSK-006",
  "restore_to_status": "Backlog",
  "user_email": "manager@company.com"
}
```

#### Node Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhook Trigger (POST /api/tasks/:task_id/restore)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Postgres: Fetch Deleted Task                               â”‚
â”‚    - SELECT * FROM tasks WHERE task_id = ? AND is_deleted = T â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. IF Node: Task Not Found or Not Deleted?                    â”‚
â”‚    - Return 404 or 400 Bad Request                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Postgres: Restore Task                                      â”‚
â”‚    - UPDATE tasks SET                                          â”‚
â”‚      status = restore_to_status,                               â”‚
â”‚      is_deleted = FALSE,                                       â”‚
â”‚      deleted_at = NULL,                                        â”‚
â”‚      deleted_by = NULL                                         â”‚
â”‚    - WHERE id = ?                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Execute Sub-Workflow: SW-002 (Write Audit Log)             â”‚
â”‚    - action: 'RESTORE'                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Respond to Webhook (200 OK)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **WF-005: Create Project**

**Trigger:** Webhook (POST /api/projects)

#### Input Payload Schema

```json
{
  "project_id": "PRJ-003",
  "project_name": "Quality Dashboard Enhancement",
  "total_weight": 4,
  "priority": "High",
  "start_date": "2025-02-15",
  "target_date": "2025-05-15",
  "user_email": "manager@company.com"
}
```

#### Node Flow (Simplified)

```
1. Webhook Trigger
2. Validate Authentication
3. Validate Input (project_id format, priority values)
4. Check Uniqueness (project_id)
5. INSERT INTO projects
6. Write Audit Log (action: CREATE)
7. Return 201 Created with project data
```

---

### **WF-006: Update Project**

**Trigger:** Webhook (PATCH /api/projects/:project_id)

#### Input Payload Schema

```json
{
  "project_id": "PRJ-001",
  "updates": {
    "priority": "High",
    "target_date": "2025-04-15"
  },
  "user_email": "manager@company.com"
}
```

#### Node Flow (Simplified)

```
1. Webhook Trigger
2. Validate Authentication
3. Fetch Current Project State
4. Validate Only User-Editable Fields (block updates to derived fields)
5. UPDATE projects
6. Write Audit Log (action: UPDATE)
7. Return 200 OK with updated project + metrics
```

---

### **WF-007: Create Resource**

**Trigger:** Webhook (POST /api/resources)

#### Input Payload Schema

```json
{
  "resource_name": "Sarah",
  "weekly_capacity_hrs": 40.0,
  "email": "sarah@company.com",
  "is_active": true,
  "user_email": "admin@company.com"
}
```

---

### **WF-008: Update Resource**

**Trigger:** Webhook (PATCH /api/resources/:resource_id)

#### Input Payload Schema

```json
{
  "resource_name": "Basel",
  "updates": {
    "weekly_capacity_hrs": 35.0,
    "is_active": false
  },
  "user_email": "admin@company.com"
}
```

---

## ğŸ”„ SCHEDULED AUTOMATION WORKFLOWS

### **WF-009: Daily Resource Utilization Check**

**Trigger:** Schedule (Daily at 9:00 AM)
**Purpose:** Calculate resource utilization and send alerts for overallocation

#### Node Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Schedule Trigger (Cron: 0 9 * * *)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Postgres: Query Resource Utilization                       â”‚
â”‚    - SELECT * FROM v_resources_utilization                     â”‚
â”‚    - WHERE is_active = TRUE AND is_deleted = FALSE            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Function: Filter Overallocated Resources                   â”‚
â”‚    - Filter where utilization_pct > 100                        â”‚
â”‚    - Filter where utilization_pct > 80 (warning threshold)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. IF Node: Any Overallocated Resources?                      â”‚
â”‚    - If yes â†’ Build alert message                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Execute WF-017 (Resource Overload Alert)                   â”‚
â”‚    - Send email to managers                                    â”‚
â”‚    - Send Slack notification                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Postgres: Log Scheduled Job Execution                      â”‚
â”‚    - INSERT INTO system_logs                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **WF-010: Weekly Project Health Report**

**Trigger:** Schedule (Weekly on Monday at 8:00 AM)
**Purpose:** Generate and email project status report

#### Node Flow

```
1. Schedule Trigger (Cron: 0 8 * * 1)
2. Postgres: Query All Projects with Metrics
   - SELECT * FROM v_projects_with_metrics WHERE is_deleted = FALSE
3. Postgres: Query Dashboard Metrics
   - SELECT * FROM v_dashboard_metrics
4. Function: Build Report Data Structure
   - Group projects by status (At Risk, On Track, Complete)
   - Calculate summary statistics
5. Execute WF-013 (Generate Project Status Report Excel)
6. Execute WF-014 (Generate PDF version)
7. Upload to Google Drive / S3
8. Execute SW-006 (Send Email with attachments)
   - To: management@company.com
   - Subject: "Weekly Project Health Report - [Date]"
   - Attachments: Excel + PDF
9. Log completion
```

---

### **WF-011: Daily Deadline Reminder**

**Trigger:** Schedule (Daily at 8:00 AM)
**Purpose:** Send reminders for tasks due in next 3 days

#### Node Flow

```
1. Schedule Trigger (Cron: 0 8 * * *)
2. Postgres: Query Tasks Approaching Deadline
   - SELECT * FROM v_tasks_with_metrics
   - WHERE is_deleted = FALSE
   - AND status NOT IN ('Done', 'Cancelled')
   - AND deadline BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '3 days'
3. Function: Group Tasks by Resource
4. Loop: For Each Resource with Upcoming Tasks
   5. Build personalized reminder email
   6. Execute SW-006 (Send Email)
7. Execute WF-018 (Send Slack reminder to project channel)
```

---

### **WF-012: Nightly Database Maintenance**

**Trigger:** Schedule (Daily at 2:00 AM)
**Purpose:** Clean up audit logs, refresh materialized views, vacuum

#### Node Flow

```
1. Schedule Trigger (Cron: 0 2 * * *)
2. Postgres: Delete Old Audit Logs (> 1 year)
3. Postgres: VACUUM ANALYZE (if needed)
4. Postgres: REFRESH MATERIALIZED VIEW (if using materialized views)
5. Postgres: Update statistics
6. Log completion with metrics (rows deleted, time taken)
```

---

## ğŸ“Š REPORTING WORKFLOWS

### **WF-013: Generate Project Status Report (Excel)**

**Trigger:** Webhook (POST /api/reports/project-status) OR Scheduled
**Purpose:** Generate Excel file with project status, task breakdown, metrics

#### Input Payload Schema

```json
{
  "report_type": "project_status",
  "filters": {
    "project_ids": ["PRJ-001", "PRJ-002"],
    "date_range": {
      "start": "2025-01-01",
      "end": "2025-01-31"
    }
  },
  "format": "xlsx",
  "delivery": "email",
  "recipient": "manager@company.com"
}
```

#### Node Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhook Trigger (POST /api/reports/project-status)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Function: Validate Report Request                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Postgres: Query Projects with Metrics                      â”‚
â”‚    - SELECT * FROM v_projects_with_metrics                     â”‚
â”‚    - WHERE project_id IN (...)                                 â”‚
â”‚    - AND created_at BETWEEN ? AND ?                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Postgres: Query Tasks for Projects                         â”‚
â”‚    - SELECT * FROM v_tasks_with_metrics                        â”‚
â”‚    - WHERE project_id IN (...)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Function: Transform Data for Excel                          â”‚
â”‚    - Build sheet structure:                                    â”‚
â”‚      Sheet 1: Project Summary                                  â”‚
â”‚      Sheet 2: Task Details                                     â”‚
â”‚      Sheet 3: Resource Allocation                              â”‚
â”‚      Sheet 4: Charts (completion %, status distribution)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. HTTP Request: Call Excel Generation Service                â”‚
â”‚    - POST to https://api.example.com/excel-generator          â”‚
â”‚    - Body: {sheets: [...], styles: {...}}                     â”‚
â”‚    - Returns: Excel file as base64 or URL                      â”‚
â”‚                                                                 â”‚
â”‚    Alternative: Use n8n Spreadsheet File node                  â”‚
â”‚    - Create workbook with sheets                               â”‚
â”‚    - Apply formatting and formulas                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Google Drive: Upload File                                   â”‚
â”‚    - Folder: /QC Reports/Project Status/                      â”‚
â”‚    - Filename: Project_Status_Report_2025-01-15.xlsx          â”‚
â”‚    - Returns: {file_id: "...", download_url: "..."}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. IF Node: Delivery Method = Email?                          â”‚
â”‚    - Execute SW-006 (Send Email with attachment)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Respond to Webhook                                          â”‚
â”‚    - Status: 200 OK                                            â”‚
â”‚    - Body: {                                                   â”‚
â”‚        success: true,                                          â”‚
â”‚        report_url: "https://drive.google.com/...",            â”‚
â”‚        filename: "Project_Status_Report_2025-01-15.xlsx"      â”‚
â”‚      }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Example Response

```json
{
  "success": true,
  "report_id": "rpt-123e4567",
  "report_type": "project_status",
  "format": "xlsx",
  "generated_at": "2025-01-15T16:45:00Z",
  "download_url": "https://drive.google.com/file/d/1abc123/view",
  "filename": "Project_Status_Report_2025-01-15.xlsx",
  "file_size": "245 KB",
  "expires_at": "2025-02-15T16:45:00Z"
}
```

---

### **WF-014: Generate Resource Utilization Report (PDF)**

**Trigger:** Webhook (POST /api/reports/resource-utilization) OR Scheduled

#### Node Flow (Simplified)

```
1. Webhook Trigger
2. Postgres: Query v_resources_utilization
3. Function: Transform data for PDF layout
4. HTTP Request: Call PDF Generation Service (e.g., Puppeteer, WeasyPrint)
   - Pass HTML template with data
   - Generate charts (utilization bar chart, pie chart)
5. Upload to S3 / Google Drive
6. Send email with download link
7. Return response with URL
```

---

### **WF-015: Generate Task List Export (CSV)**

**Trigger:** Webhook (POST /api/reports/task-export)

#### Node Flow (Simplified)

```
1. Webhook Trigger
2. Postgres: Query v_tasks_with_metrics with filters
3. Function: Transform to CSV format
4. n8n CSV node: Generate CSV file
5. Upload to Google Drive / S3
6. Return download URL
```

---

### **WF-016: Generate Dashboard Snapshot (Excel + PDF)**

**Trigger:** Webhook (POST /api/reports/dashboard) OR Scheduled (Weekly)

#### Node Flow

```
1. Trigger (Webhook or Schedule)
2. Postgres: Query v_dashboard_metrics
3. Postgres: Query project health data
4. Postgres: Query resource utilization
5. Function: Build comprehensive dashboard data
6. Execute WF-013 (Generate Excel version)
7. Execute WF-014 (Generate PDF version)
8. Upload both to Google Drive
9. Send email with both attachments
10. Return URLs
```

---

## ğŸ”” NOTIFICATION WORKFLOWS

### **WF-017: Resource Overload Alert**

**Trigger:** Called by other workflows OR Scheduled
**Purpose:** Alert when resource utilization exceeds threshold

#### Input Schema

```json
{
  "resource_name": "Basel",
  "utilization_pct": 120.0,
  "current_allocation_hrs": 48.0,
  "weekly_capacity_hrs": 40.0,
  "overallocated_by_hrs": 8.0,
  "assigned_tasks": [
    {"task_id": "TSK-001", "estimate_hrs": 40.0},
    {"task_id": "TSK-007", "estimate_hrs": 8.0}
  ]
}
```

#### Node Flow

```
1. Webhook Trigger (Internal call from other workflows)
2. Function: Build Alert Message
   - "âš ï¸ Resource Overload Alert: Basel is 120% utilized"
   - List tasks causing overallocation
3. Execute SW-006 (Send Email)
   - To: managers, resource owner
   - Subject: "Resource Overload: Basel"
   - Body: HTML email with task breakdown
4. Slack: Send Message to #project-alerts channel
   - Use Slack webhook
   - Format: Slack blocks with action buttons
5. Postgres: Log notification sent
```

---

### **WF-018: Task Deadline Alert**

**Trigger:** Called by WF-011 OR Event-triggered

#### Node Flow

```
1. Webhook Trigger
2. Function: Build Reminder Message
3. Execute SW-006 (Send Email to assigned resources)
4. Slack: Send DM to resource
5. Log notification
```

---

### **WF-019: Project At Risk Alert**

**Trigger:** Event-triggered (when project status changes to "At Risk")

#### Node Flow

```
1. Webhook Trigger (called from WF-002 when task updated)
2. Postgres: Query v_projects_with_metrics for project
3. IF completion_pct < 70% AND status = 'At Risk'
4. Function: Build alert message
5. Execute SW-006 (Send Email to project stakeholders)
6. Slack: Post to project channel
```

---

### **WF-020: Validation Failure Notification**

**Trigger:** Called by CRUD workflows when validation fails

#### Input Schema

```json
{
  "workflow": "WF-001",
  "operation": "Create Task",
  "user_email": "user@company.com",
  "validation_errors": [
    "Invalid task_id format: must be TSK-XXX",
    "Resource 'John' not found in database"
  ],
  "payload": {...}
}
```

#### Node Flow

```
1. Webhook Trigger (Internal)
2. Function: Build error report
3. Execute SW-006 (Send Email to user)
   - Subject: "Task Creation Failed - Validation Errors"
   - Body: List of errors with suggestions
4. Log validation failure in audit_log
```

---

## ğŸ”§ REUSABLE SUB-WORKFLOWS

### **SW-001: Validate Task Input**

**Purpose:** Centralized input validation for task operations
**Called By:** WF-001, WF-002

#### Input Schema

```json
{
  "task_id": "TSK-007",
  "project_id": "PRJ-001",
  "task_name": "...",
  "status": "Backlog",
  "estimate_days": 3.0,
  "r1_estimate_hrs": 24.0,
  "r1_actual_hrs": 0.0,
  "operation": "create"
}
```

#### Validation Rules

```javascript
// Pseudo-code for validation function
function validateTaskInput(input) {
  const errors = [];

  // 1. Required fields
  if (!input.task_id) errors.push("task_id is required");
  if (!input.project_id) errors.push("project_id is required");
  if (!input.task_name) errors.push("task_name is required");
  if (!input.resource1_name) errors.push("resource1_name is required");

  // 2. Format validation
  if (input.task_id && !/^TSK-[0-9]{3}$/.test(input.task_id)) {
    errors.push("task_id must match format TSK-XXX (e.g., TSK-001)");
  }

  // 3. Status validation
  const validStatuses = ['Backlog', 'In Progress', 'Done', 'Cancelled'];
  if (input.status && !validStatuses.includes(input.status)) {
    errors.push(`status must be one of: ${validStatuses.join(', ')}`);
  }

  // 4. Hours validation
  if (input.r1_estimate_hrs < 0) errors.push("r1_estimate_hrs must be >= 0");
  if (input.r1_actual_hrs < 0) errors.push("r1_actual_hrs must be >= 0");
  if (input.r2_estimate_hrs < 0) errors.push("r2_estimate_hrs must be >= 0");
  if (input.r2_actual_hrs < 0) errors.push("r2_actual_hrs must be >= 0");

  // 5. Resource 2 logic
  if (!input.resource2_name) {
    if (input.r2_estimate_hrs > 0 || input.r2_actual_hrs > 0) {
      errors.push("Cannot have R2 hours without Resource 2 assigned");
    }
  }

  // 6. Done task requirements
  if (input.status === 'Done') {
    if (!input.completed_date) {
      errors.push("completed_date required when status is Done");
    }
    const totalActual = input.r1_actual_hrs + input.r2_actual_hrs;
    if (totalActual === 0) {
      errors.push("Total actual hours must be > 0 when status is Done");
    }
  }

  return {
    valid: errors.length === 0,
    errors: errors
  };
}
```

#### Output Schema

```json
{
  "valid": false,
  "errors": [
    "task_id must match format TSK-XXX",
    "r1_estimate_hrs must be >= 0"
  ]
}
```

---

### **SW-002: Write Audit Log**

**Purpose:** Centralized audit logging for all mutations
**Called By:** All CRUD workflows

#### Input Schema

```json
{
  "action": "CREATE",
  "entity_name": "tasks",
  "entity_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_email": "user@company.com",
  "before_json": null,
  "after_json": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "task_id": "TSK-007",
    "task_name": "...",
    "status": "Backlog"
  },
  "changed_fields": [],
  "metadata": {
    "workflow_id": "WF-001",
    "ip_address": "192.168.1.10",
    "user_agent": "n8n/1.0"
  }
}
```

#### Node Flow

```
1. Function: Generate audit log ID (UUID)
2. Function: Calculate changed_fields (if UPDATE)
   - Compare before_json and after_json
   - Extract keys that differ
3. Postgres: INSERT INTO audit_log
   - INSERT INTO audit_log (id, action, entity_name, entity_id, ...)
   - VALUES (?, ?, ?, ?, ...)
4. Return: {audit_id: "..."}
```

---

### **SW-003: Check Resource Availability**

**Purpose:** Check if resource has capacity for new task assignment
**Called By:** WF-001, WF-002

#### Input Schema

```json
{
  "resource_name": "Basel",
  "additional_hours": 24.0
}
```

#### Node Flow

```
1. Postgres: Query current resource utilization
   - SELECT * FROM v_resources_utilization
   - WHERE resource_name = ?
2. Function: Calculate new utilization
   - new_allocation = current_allocation + additional_hours
   - new_utilization_pct = (new_allocation / capacity) * 100
3. Function: Generate warning if needed
   - If new_utilization_pct > 100: "Resource will be overallocated"
   - If new_utilization_pct > 80: "Resource near capacity"
4. Return: {
     available: true/false,
     current_utilization_pct: 75.0,
     new_utilization_pct: 95.0,
     warning: "Resource will be at 95% capacity"
   }
```

---

### **SW-004: Validate Status Transition**

**Purpose:** Enforce state machine rules for task status transitions
**Called By:** WF-002

#### Input Schema

```json
{
  "from_status": "Backlog",
  "to_status": "In Progress",
  "task_data": {
    "completed_date": null
  }
}
```

#### Transition Rules

```javascript
// Allowed transitions
const transitions = {
  'Backlog': ['In Progress', 'Cancelled'],
  'In Progress': ['Done', 'Cancelled'],
  'Done': [],  // Terminal state
  'Cancelled': []  // Terminal state
};

// Required fields per transition
const requiredFields = {
  'In Progress â†’ Done': ['completed_date'],
};
```

#### Node Flow

```
1. Postgres: Query status_transitions table
   - SELECT * FROM status_transitions
   - WHERE from_status = ? AND to_status = ?
2. IF transition not allowed
   - Return {allowed: false, error: "Cannot transition from X to Y"}
3. Function: Check required fields
   - Get required_fields from status_transitions
   - Validate all required fields are present and not null
4. Return: {
     allowed: true/false,
     errors: [...],
     required_fields: [...]
   }
```

---

### **SW-005: Calculate Project Metrics**

**Purpose:** Recalculate project-level aggregations (typically handled by views)
**Called By:** WF-003 (after task deletion)

#### Node Flow

```
1. Postgres: Query v_projects_with_metrics
   - SELECT * FROM v_projects_with_metrics WHERE id = ?
2. Function: Validate metrics
3. Return: {project_id: "...", completion_pct: 45.5, status: "On Track"}
```

**Note:** This sub-workflow is primarily for triggering recalculations in materialized views if used, or for caching metrics. With regular views, metrics are always real-time.

---

### **SW-006: Send Email Notification**

**Purpose:** Centralized email sending with template support
**Called By:** All notification workflows

#### Input Schema

```json
{
  "to": "user@company.com",
  "cc": ["manager@company.com"],
  "subject": "Task Deadline Reminder",
  "template": "task_deadline_reminder",
  "variables": {
    "task_name": "Mobile View Testing",
    "deadline": "2025-01-31",
    "days_remaining": 3
  },
  "attachments": [
    {
      "filename": "report.xlsx",
      "content": "<base64>",
      "content_type": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    }
  ]
}
```

#### Node Flow

```
1. Function: Load Email Template
   - Fetch HTML template from storage or inline
   - Replace {{variables}} with actual values
2. Email Node: Send Email
   - SMTP configuration (Gmail, SendGrid, etc.)
   - From: noreply@company.com
   - To/CC/BCC from input
   - Subject and HTML body
   - Attachments
3. Postgres: Log email sent
   - INSERT INTO email_logs (recipient, subject, sent_at, status)
4. Return: {success: true, message_id: "..."}
```

---

## ğŸ“ EXAMPLE NODE CONFIGURATIONS

### Example 1: HTTP Webhook Node Configuration

```json
{
  "name": "Webhook - Create Task",
  "type": "n8n-nodes-base.webhook",
  "typeVersion": 1,
  "position": [250, 300],
  "webhookId": "create-task",
  "parameters": {
    "path": "api/tasks",
    "httpMethod": "POST",
    "responseMode": "responseNode",
    "responseData": "allEntries",
    "options": {
      "responseHeaders": {
        "entries": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ]
      }
    }
  }
}
```

**Example Webhook URL:**
```
https://n8n.company.com/webhook/api/tasks
```

**Example Request:**
```bash
curl -X POST https://n8n.company.com/webhook/api/tasks \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-secret-key-here" \
  -d '{
    "task_id": "TSK-007",
    "project_id": "PRJ-001",
    "task_name": "Implement authentication",
    "status": "Backlog",
    "estimate_days": 3.0,
    "resource1_name": "Basel",
    "r1_estimate_hrs": 24.0,
    "r1_actual_hrs": 0.0,
    "deadline": "2025-02-15",
    "user_email": "manager@company.com"
  }'
```

---

### Example 2: Postgres Node - INSERT Task

```json
{
  "name": "Postgres - Insert Task",
  "type": "n8n-nodes-base.postgres",
  "typeVersion": 2,
  "position": [850, 300],
  "credentials": {
    "postgres": {
      "id": "1",
      "name": "QC Database"
    }
  },
  "parameters": {
    "operation": "executeQuery",
    "query": "INSERT INTO tasks (\n  id,\n  task_id,\n  project_id,\n  task_name,\n  status,\n  estimate_days,\n  resource1_id,\n  r1_estimate_hrs,\n  r1_actual_hrs,\n  resource2_id,\n  r2_estimate_hrs,\n  r2_actual_hrs,\n  deadline,\n  completed_date,\n  tags,\n  notes,\n  created_by,\n  updated_by\n)\nVALUES (\n  '{{ $json.task_uuid }}',\n  '{{ $json.task_id }}',\n  '{{ $json.project_uuid }}',\n  '{{ $json.task_name }}',\n  '{{ $json.status }}',\n  {{ $json.estimate_days }},\n  '{{ $json.resource1_uuid }}',\n  {{ $json.r1_estimate_hrs }},\n  {{ $json.r1_actual_hrs }},\n  {{ $json.resource2_uuid ? \"'\" + $json.resource2_uuid + \"'\" : \"NULL\" }},\n  {{ $json.r2_estimate_hrs }},\n  {{ $json.r2_actual_hrs }},\n  '{{ $json.deadline }}',\n  {{ $json.completed_date ? \"'\" + $json.completed_date + \"'\" : \"NULL\" }},\n  ARRAY[{{ $json.tags ? $json.tags.map(t => \"'\" + t + \"'\").join(',') : \"\" }}],\n  '{{ $json.notes }}',\n  '{{ $json.user_email }}',\n  '{{ $json.user_email }}'\n)\nRETURNING *;",
    "options": {}
  }
}
```

**Alternative: Parameterized Query (Safer)**

```javascript
// In Function node before Postgres node
const params = {
  id: generateUUID(),
  task_id: $input.item.json.task_id,
  project_id: $input.item.json.project_uuid,
  task_name: $input.item.json.task_name,
  status: $input.item.json.status,
  estimate_days: $input.item.json.estimate_days,
  resource1_id: $input.item.json.resource1_uuid,
  r1_estimate_hrs: $input.item.json.r1_estimate_hrs,
  r1_actual_hrs: $input.item.json.r1_actual_hrs,
  resource2_id: $input.item.json.resource2_uuid || null,
  r2_estimate_hrs: $input.item.json.r2_estimate_hrs,
  r2_actual_hrs: $input.item.json.r2_actual_hrs,
  deadline: $input.item.json.deadline,
  completed_date: $input.item.json.completed_date || null,
  tags: $input.item.json.tags || [],
  notes: $input.item.json.notes || '',
  user_email: $input.item.json.user_email
};

return { json: { params } };
```

Then in Postgres node:
```sql
INSERT INTO tasks (
  id, task_id, project_id, task_name, status,
  estimate_days, resource1_id, r1_estimate_hrs, r1_actual_hrs,
  resource2_id, r2_estimate_hrs, r2_actual_hrs,
  deadline, completed_date, tags, notes,
  created_by, updated_by
)
VALUES (
  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10,
  $11, $12, $13, $14, $15, $16, $17, $17
)
RETURNING *;
```

---

### Example 3: Function Node - Validate Task Input

```javascript
// n8n Function node
// Access input data
const input = $input.item.json;

// Validation errors array
const errors = [];

// 1. Required fields
if (!input.task_id) errors.push("task_id is required");
if (!input.project_id) errors.push("project_id is required");
if (!input.task_name) errors.push("task_name is required");
if (!input.resource1_name) errors.push("resource1_name is required");
if (!input.user_email) errors.push("user_email is required");

// 2. Format validation - task_id
if (input.task_id && !/^TSK-[0-9]{3}$/.test(input.task_id)) {
  errors.push("task_id must match format TSK-XXX (e.g., TSK-001)");
}

// 3. Status validation
const validStatuses = ['Backlog', 'In Progress', 'Done', 'Cancelled'];
if (input.status && !validStatuses.includes(input.status)) {
  errors.push(`status must be one of: ${validStatuses.join(', ')}`);
}

// 4. Hours validation
if (input.r1_estimate_hrs !== undefined && input.r1_estimate_hrs < 0) {
  errors.push("r1_estimate_hrs must be >= 0");
}
if (input.r1_actual_hrs !== undefined && input.r1_actual_hrs < 0) {
  errors.push("r1_actual_hrs must be >= 0");
}
if (input.r2_estimate_hrs !== undefined && input.r2_estimate_hrs < 0) {
  errors.push("r2_estimate_hrs must be >= 0");
}
if (input.r2_actual_hrs !== undefined && input.r2_actual_hrs < 0) {
  errors.push("r2_actual_hrs must be >= 0");
}

// 5. Resource 2 logic
if (!input.resource2_name) {
  if ((input.r2_estimate_hrs || 0) > 0 || (input.r2_actual_hrs || 0) > 0) {
    errors.push("Cannot have R2 hours without Resource 2 assigned");
  }
}

// 6. Done task requirements
if (input.status === 'Done') {
  if (!input.completed_date) {
    errors.push("completed_date required when status is Done");
  }
  const totalActual = (input.r1_actual_hrs || 0) + (input.r2_actual_hrs || 0);
  if (totalActual === 0) {
    errors.push("Total actual hours must be > 0 when status is Done");
  }
}

// 7. Deadline validation
if (input.deadline) {
  const deadlineDate = new Date(input.deadline);
  if (isNaN(deadlineDate.getTime())) {
    errors.push("deadline must be a valid date");
  }
}

// Return validation result
return {
  json: {
    valid: errors.length === 0,
    errors: errors,
    input: input
  }
};
```

---

### Example 4: Postgres Node - UPDATE Task

```json
{
  "name": "Postgres - Update Task",
  "type": "n8n-nodes-base.postgres",
  "typeVersion": 2,
  "position": [1050, 300],
  "parameters": {
    "operation": "executeQuery",
    "query": "UPDATE tasks\nSET\n  status = COALESCE($1, status),\n  r1_actual_hrs = COALESCE($2, r1_actual_hrs),\n  r2_actual_hrs = COALESCE($3, r2_actual_hrs),\n  completed_date = COALESCE($4, completed_date),\n  notes = COALESCE($5, notes),\n  updated_by = $6,\n  updated_at = CURRENT_TIMESTAMP\nWHERE id = $7\n  AND is_deleted = FALSE\nRETURNING *;",
    "additionalFields": {
      "queryParameters": {
        "parameters": [
          {
            "parameter": "={{ $json.updates.status }}"
          },
          {
            "parameter": "={{ $json.updates.r1_actual_hrs }}"
          },
          {
            "parameter": "={{ $json.updates.r2_actual_hrs }}"
          },
          {
            "parameter": "={{ $json.updates.completed_date }}"
          },
          {
            "parameter": "={{ $json.updates.notes }}"
          },
          {
            "parameter": "={{ $json.user_email }}"
          },
          {
            "parameter": "={{ $json.task_uuid }}"
          }
        ]
      }
    }
  }
}
```

---

### Example 5: Google Drive Upload Node

```json
{
  "name": "Google Drive - Upload Report",
  "type": "n8n-nodes-base.googleDrive",
  "typeVersion": 3,
  "position": [1450, 500],
  "credentials": {
    "googleDriveOAuth2Api": {
      "id": "2",
      "name": "Google Drive - QC Reports"
    }
  },
  "parameters": {
    "operation": "upload",
    "name": "={{ $json.filename }}",
    "resolveData": true,
    "parents": {
      "mode": "list",
      "value": [
        {
          "folderId": "1abc123xyz789"
        }
      ]
    },
    "options": {
      "keepRevisionForever": false,
      "ocrLanguage": "en",
      "useContentAsIndexableText": true
    }
  }
}
```

**Alternative: AWS S3 Upload Node**

```json
{
  "name": "S3 - Upload Report",
  "type": "n8n-nodes-base.awsS3",
  "typeVersion": 1,
  "position": [1450, 500],
  "credentials": {
    "aws": {
      "id": "3",
      "name": "AWS - Production"
    }
  },
  "parameters": {
    "operation": "upload",
    "bucketName": "qc-reports",
    "fileName": "={{ $json.filename }}",
    "isBinaryData": true,
    "binaryPropertyName": "data",
    "additionalFields": {
      "acl": "public-read",
      "contentType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      "storageClass": "STANDARD"
    }
  }
}
```

---

### Example 6: Send Email Node

```json
{
  "name": "Send Email - Task Reminder",
  "type": "n8n-nodes-base.emailSend",
  "typeVersion": 2,
  "position": [1250, 600],
  "credentials": {
    "smtp": {
      "id": "4",
      "name": "Company SMTP"
    }
  },
  "parameters": {
    "fromEmail": "noreply@company.com",
    "toEmail": "={{ $json.recipient_email }}",
    "subject": "Task Deadline Reminder: {{ $json.task_name }}",
    "emailType": "html",
    "message": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; }\n    .header { background-color: #007BFF; color: white; padding: 20px; }\n    .content { padding: 20px; }\n    .task-info { background-color: #f8f9fa; padding: 15px; margin: 10px 0; }\n    .deadline { color: #dc3545; font-weight: bold; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <h2>Task Deadline Reminder</h2>\n  </div>\n  <div class=\"content\">\n    <p>Hi {{ $json.resource_name }},</p>\n    <p>This is a reminder that the following task is due soon:</p>\n    <div class=\"task-info\">\n      <p><strong>Task:</strong> {{ $json.task_name }}</p>\n      <p><strong>Task ID:</strong> {{ $json.task_id }}</p>\n      <p><strong>Status:</strong> {{ $json.status }}</p>\n      <p><strong>Deadline:</strong> <span class=\"deadline\">{{ $json.deadline }}</span></p>\n      <p><strong>Days Remaining:</strong> {{ $json.days_remaining }}</p>\n      <p><strong>Completion:</strong> {{ $json.overall_completion_pct }}%</p>\n    </div>\n    <p>Please update the task status if work is in progress.</p>\n    <p><a href=\"https://qc.company.com/tasks/{{ $json.task_id }}\">View Task</a></p>\n  </div>\n</body>\n</html>",
    "options": {
      "attachments": "data",
      "ccEmail": "manager@company.com"
    }
  }
}
```

---

### Example 7: Slack Message Node

```json
{
  "name": "Slack - Resource Alert",
  "type": "n8n-nodes-base.slack",
  "typeVersion": 1,
  "position": [1450, 700],
  "credentials": {
    "slackApi": {
      "id": "5",
      "name": "Slack - QC Workspace"
    }
  },
  "parameters": {
    "resource": "message",
    "operation": "post",
    "channel": "#project-alerts",
    "text": "",
    "attachments": [],
    "blocksUi": {
      "blocksValues": [
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": ":warning: *Resource Overload Alert*\n\n*Resource:* {{ $json.resource_name }}\n*Utilization:* {{ $json.utilization_pct }}%\n*Capacity:* {{ $json.weekly_capacity_hrs }} hrs/week\n*Current Allocation:* {{ $json.current_allocation_hrs }} hrs\n*Overallocated by:* {{ $json.overallocated_by_hrs }} hrs"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*Assigned Tasks:*\n{{ $json.assigned_tasks.map(t => `â€¢ ${t.task_id}: ${t.task_name} (${t.estimate_hrs} hrs)`).join('\\n') }}"
          }
        },
        {
          "type": "actions",
          "elements": [
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Resource"
              },
              "url": "https://qc.company.com/resources/{{ $json.resource_name }}"
            },
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "Reassign Tasks"
              },
              "url": "https://qc.company.com/tasks?resource={{ $json.resource_name }}"
            }
          ]
        }
      ]
    }
  }
}
```

---

## ğŸ”§ ERROR HANDLING & RETRY STRATEGY

### Error Handling Principles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Error Handling Layers                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ 1. INPUT VALIDATION (Before DB operations)                  â”‚
â”‚    - Fail fast with clear error messages                    â”‚
â”‚    - Return 400 Bad Request                                  â”‚
â”‚    - No retry needed                                         â”‚
â”‚                                                              â”‚
â”‚ 2. DATABASE ERRORS (Connection, constraint violations)      â”‚
â”‚    - Retry with exponential backoff                          â”‚
â”‚    - Max 3 retries                                           â”‚
â”‚    - Log all attempts                                        â”‚
â”‚                                                              â”‚
â”‚ 3. EXTERNAL SERVICE ERRORS (Email, Drive, Slack)           â”‚
â”‚    - Retry with exponential backoff                          â”‚
â”‚    - Max 5 retries                                           â”‚
â”‚    - Gracefully degrade (continue workflow if non-critical)  â”‚
â”‚                                                              â”‚
â”‚ 4. WORKFLOW LOGIC ERRORS (Unexpected conditions)            â”‚
â”‚    - Log error with full context                             â”‚
â”‚    - Send alert to admin                                     â”‚
â”‚    - Return 500 Internal Server Error                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retry Configuration Examples

#### Database Operations

```json
{
  "retryOnFail": true,
  "maxTries": 3,
  "waitBetweenTries": 1000,
  "continueOnFail": false
}
```

#### External API Calls (Email, Slack, Drive)

```json
{
  "retryOnFail": true,
  "maxTries": 5,
  "waitBetweenTries": 2000,
  "continueOnFail": true
}
```

#### Critical Operations (Audit Logging)

```json
{
  "retryOnFail": true,
  "maxTries": 10,
  "waitBetweenTries": 5000,
  "continueOnFail": false
}
```

### Error Response Function Node

```javascript
// Function node for error handling
const error = $input.item.json.error || {};
const statusCode = error.statusCode || 500;

// Categorize error
let category = 'UNKNOWN';
if (statusCode >= 400 && statusCode < 500) {
  category = 'CLIENT_ERROR';
} else if (statusCode >= 500) {
  category = 'SERVER_ERROR';
}

// Build error response
const errorResponse = {
  success: false,
  error: {
    code: error.code || 'INTERNAL_ERROR',
    message: error.message || 'An unexpected error occurred',
    category: category,
    details: error.details || {},
    timestamp: new Date().toISOString(),
    request_id: $workflow.id
  }
};

// Log to database (optional)
// INSERT INTO error_logs (workflow_id, error_code, error_message, ...)

return {
  json: errorResponse,
  statusCode: statusCode
};
```

### Exponential Backoff Implementation

```javascript
// Function node for calculating backoff delay
const attemptNumber = $input.item.json.attemptNumber || 1;
const baseDelay = 1000; // 1 second
const maxDelay = 60000; // 60 seconds

// Exponential backoff: delay = baseDelay * 2^(attempt - 1)
let delay = Math.min(baseDelay * Math.pow(2, attemptNumber - 1), maxDelay);

// Add jitter (randomness) to prevent thundering herd
delay = delay + (Math.random() * 1000);

return {
  json: {
    delay: Math.floor(delay),
    attemptNumber: attemptNumber + 1
  }
};
```

### Global Error Catcher Workflow

Create a dedicated workflow to handle errors from all other workflows:

```
WF-ERROR-HANDLER: Global Error Catcher

Trigger: Webhook (called by error blocks in all workflows)

Input:
{
  "workflow_id": "WF-001",
  "workflow_name": "Create Task",
  "error": {...},
  "input_data": {...},
  "timestamp": "..."
}

Node Flow:
1. Function: Parse error details
2. IF: Error is critical?
   - Send Slack alert to #dev-alerts
   - Send email to on-call engineer
3. Postgres: Log error to error_logs table
4. IF: Error is retryable?
   - Requeue job with exponential backoff
5. Return error response to caller
```

---

## ğŸ”’ SECURITY BEST PRACTICES

### 1. Webhook Authentication

#### Method A: API Key Header (Recommended for Internal Use)

```javascript
// Function node: Validate API Key
const apiKey = $input.item.headers['x-api-key'];
const validApiKey = process.env.QC_API_KEY; // Store in n8n credentials

if (!apiKey || apiKey !== validApiKey) {
  return {
    json: {
      success: false,
      error: {
        code: 'UNAUTHORIZED',
        message: 'Invalid or missing API key'
      }
    },
    statusCode: 401
  };
}

// Continue to next node
return { json: $input.item.json };
```

**Client Usage:**
```bash
curl -X POST https://n8n.company.com/webhook/api/tasks \
  -H "X-API-Key: your-secret-key-here" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

#### Method B: HMAC Signature (Recommended for External Partners)

```javascript
// Function node: Validate HMAC Signature
const crypto = require('crypto');

const receivedSignature = $input.item.headers['x-signature'];
const payload = JSON.stringify($input.item.json);
const secret = process.env.WEBHOOK_SECRET;

// Calculate expected signature
const expectedSignature = crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

if (receivedSignature !== expectedSignature) {
  return {
    json: {
      success: false,
      error: {
        code: 'INVALID_SIGNATURE',
        message: 'HMAC signature verification failed'
      }
    },
    statusCode: 401
  };
}

return { json: $input.item.json };
```

**Client Usage:**
```javascript
const crypto = require('crypto');
const payload = JSON.stringify(data);
const secret = 'shared-secret-key';
const signature = crypto.createHmac('sha256', secret).update(payload).digest('hex');

fetch('https://n8n.company.com/webhook/api/tasks', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Signature': signature
  },
  body: payload
});
```

#### Method C: JWT Token (Recommended for Multi-User Systems)

```javascript
// Function node: Validate JWT Token
const jwt = require('jsonwebtoken');

const authHeader = $input.item.headers['authorization'];
if (!authHeader || !authHeader.startsWith('Bearer ')) {
  return {
    json: { error: 'Missing or invalid authorization header' },
    statusCode: 401
  };
}

const token = authHeader.substring(7);
const secret = process.env.JWT_SECRET;

try {
  const decoded = jwt.verify(token, secret);

  // Add user info to workflow context
  return {
    json: {
      ...$input.item.json,
      user_email: decoded.email,
      user_id: decoded.sub,
      user_roles: decoded.roles
    }
  };
} catch (error) {
  return {
    json: { error: 'Invalid or expired token' },
    statusCode: 401
  };
}
```

### 2. IP Allowlist

Configure at n8n level or use reverse proxy (Nginx, Cloudflare):

```nginx
# Nginx configuration
location /webhook/ {
    # Allow only internal network
    allow 10.0.0.0/8;
    allow 192.168.0.0/16;

    # Allow specific external partner IPs
    allow 203.0.113.0/24;

    # Deny all others
    deny all;

    proxy_pass http://n8n:5678;
}
```

### 3. Rate Limiting

```javascript
// Function node: Rate Limiting (using Redis or in-memory cache)
const clientIp = $input.item.headers['x-forwarded-for'] ||
                 $input.item.headers['x-real-ip'] ||
                 'unknown';

const rateLimit = 100; // requests per minute
const window = 60; // seconds

// Check rate limit (pseudo-code - implement with Redis)
const currentCount = await redis.get(`rate:${clientIp}`);

if (currentCount && parseInt(currentCount) >= rateLimit) {
  return {
    json: {
      error: 'Rate limit exceeded. Max 100 requests per minute.'
    },
    statusCode: 429
  };
}

// Increment counter
await redis.incr(`rate:${clientIp}`);
await redis.expire(`rate:${clientIp}`, window);

return { json: $input.item.json };
```

### 4. Input Sanitization

```javascript
// Function node: Sanitize Input
const sanitizeHtml = require('sanitize-html');

const input = $input.item.json;

// Sanitize string fields to prevent XSS
if (input.task_name) {
  input.task_name = sanitizeHtml(input.task_name, {
    allowedTags: [],
    allowedAttributes: {}
  });
}

if (input.notes) {
  input.notes = sanitizeHtml(input.notes, {
    allowedTags: ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
    allowedAttributes: {
      'a': ['href']
    }
  });
}

// Prevent SQL injection (use parameterized queries)
// Prevent NoSQL injection (validate types)

return { json: input };
```

### 5. Secrets Management

**Use n8n Credentials Store:**
- Store API keys, database passwords, SMTP credentials in n8n's encrypted credentials store
- Never hardcode secrets in workflow nodes
- Use environment variables for sensitive configuration

**Example:**
```javascript
// âŒ BAD: Hardcoded secret
const apiKey = 'sk-1234567890abcdef';

// âœ… GOOD: Use n8n credentials
const credentials = await this.getCredentials('qcApiKey');
const apiKey = credentials.apiKey;
```

### 6. Audit Logging for Security Events

Log all security-relevant events:
- Failed authentication attempts
- Invalid API keys
- Rate limit exceeded
- Unauthorized access attempts
- Suspicious activity patterns

```javascript
// Function node: Log Security Event
const securityEvent = {
  event_type: 'AUTH_FAILURE',
  ip_address: $input.item.headers['x-forwarded-for'],
  user_agent: $input.item.headers['user-agent'],
  attempted_endpoint: '/api/tasks',
  timestamp: new Date().toISOString(),
  details: {
    reason: 'Invalid API key'
  }
};

// Insert into security_logs table
// Optionally trigger alert if pattern detected (multiple failures from same IP)
```

### 7. HTTPS Only

- **Always use HTTPS** for webhook endpoints
- Configure SSL/TLS certificates (Let's Encrypt, Cloudflare)
- Reject HTTP requests

### 8. CORS Configuration

If webhooks are called from browser:

```javascript
// In webhook response node
const headers = {
  'Access-Control-Allow-Origin': 'https://qc.company.com',
  'Access-Control-Allow-Methods': 'POST, GET, PATCH, DELETE',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-API-Key',
  'Access-Control-Max-Age': '86400'
};
```

---

## âœ… ACCEPTANCE CRITERIA CHECKLIST

### Business Rules Enforcement

- [x] **Task ID Format Validation** (TSK-XXX)
  - Enforced in: SW-001 (Validate Task Input)
  - Also enforced in: Database CHECK constraint

- [x] **Project ID Format Validation** (PRJ-XXX)
  - Enforced in: WF-005 (Create Project) validation
  - Also enforced in: Database CHECK constraint

- [x] **Status Transition Rules**
  - Enforced in: SW-004 (Validate Status Transition)
  - Allowed transitions:
    - Backlog â†’ In Progress âœ…
    - Backlog â†’ Cancelled âœ…
    - In Progress â†’ Done âœ…
    - In Progress â†’ Cancelled âœ…
    - Done/Cancelled â†’ (none) âœ…

- [x] **Done Task Requirements**
  - Enforced in: SW-001 (Validate Task Input)
  - Status = 'Done' requires:
    - completed_date must be set âœ…
    - total_actual_hrs > 0 âœ…

- [x] **Hours Validation**
  - Enforced in: SW-001 (Validate Task Input)
  - All hour fields >= 0 âœ…
  - Resource 2 hours = 0 if Resource 2 not assigned âœ…

- [x] **Foreign Key Validation**
  - Enforced in: WF-001 (Create Task) step 5
  - project_id must exist âœ…
  - resource1_id must exist âœ…
  - resource2_id must exist (if provided) âœ…

- [x] **Uniqueness Constraints**
  - Enforced in: WF-001 (Create Task) step 7
  - task_id must be unique among non-deleted tasks âœ…
  - Also enforced in: Database UNIQUE INDEX

- [x] **Resource Capacity Checks**
  - Enforced in: SW-003 (Check Resource Availability)
  - Warning issued if utilization > 80% âœ…
  - Alert triggered if utilization > 100% âœ…

### Audit Trail

- [x] **CREATE Actions Logged**
  - WF-001 (Create Task) â†’ SW-002 âœ…
  - WF-005 (Create Project) â†’ SW-002 âœ…
  - WF-007 (Create Resource) â†’ SW-002 âœ…

- [x] **UPDATE Actions Logged**
  - WF-002 (Update Task) â†’ SW-002 âœ…
  - WF-006 (Update Project) â†’ SW-002 âœ…
  - WF-008 (Update Resource) â†’ SW-002 âœ…

- [x] **DELETE Actions Logged**
  - WF-003 (Soft Delete Task) â†’ SW-002 âœ…
  - Action: 'DELETE', before/after states captured âœ…

- [x] **RESTORE Actions Logged**
  - WF-004 (Restore Task) â†’ SW-002 âœ…
  - Action: 'RESTORE', before/after states captured âœ…

- [x] **Audit Log Contains Required Fields**
  - id (UUID) âœ…
  - action (CREATE/UPDATE/DELETE/RESTORE) âœ…
  - entity_name (table name) âœ…
  - entity_id (record UUID) âœ…
  - user_email âœ…
  - before_json âœ…
  - after_json âœ…
  - changed_fields âœ…
  - metadata âœ…
  - timestamp âœ…

### Reporting

- [x] **Project Status Report (Excel)**
  - WF-013: Generate Project Status Report âœ…
  - Includes: Project summary, task details, metrics âœ…
  - Uploaded to Google Drive / S3 âœ…
  - Returns downloadable link âœ…

- [x] **Resource Utilization Report (PDF)**
  - WF-014: Generate Resource Utilization Report âœ…
  - Includes: Resource allocation, utilization charts âœ…
  - Uploaded to Google Drive / S3 âœ…
  - Returns downloadable link âœ…

- [x] **Task List Export (CSV)**
  - WF-015: Generate Task List Export âœ…
  - CSV format for spreadsheet import âœ…
  - Returns downloadable link âœ…

- [x] **Dashboard Snapshot**
  - WF-016: Generate Dashboard Snapshot âœ…
  - Excel + PDF versions âœ…
  - Contains all dashboard metrics âœ…
  - Returns downloadable links âœ…

- [x] **Report Delivery**
  - Email delivery with attachments âœ…
  - Direct download links âœ…
  - Storage in Google Drive / S3 âœ…

### API Completeness

- [x] **Task CRUD Operations**
  - POST /api/tasks (Create) âœ…
  - PATCH /api/tasks/:id (Update) âœ…
  - DELETE /api/tasks/:id (Soft Delete) âœ…
  - POST /api/tasks/:id/restore (Restore) âœ…

- [x] **Project CRUD Operations**
  - POST /api/projects (Create) âœ…
  - PATCH /api/projects/:id (Update) âœ…

- [x] **Resource CRUD Operations**
  - POST /api/resources (Create) âœ…
  - PATCH /api/resources/:id (Update) âœ…

- [x] **Report Generation Endpoints**
  - POST /api/reports/project-status âœ…
  - POST /api/reports/resource-utilization âœ…
  - POST /api/reports/task-export âœ…
  - POST /api/reports/dashboard âœ…

### Notifications

- [x] **Resource Overload Alerts**
  - WF-017: Resource Overload Alert âœ…
  - Triggered when utilization > 100% âœ…
  - Email + Slack notifications âœ…

- [x] **Task Deadline Alerts**
  - WF-018: Task Deadline Alert âœ…
  - Reminders for tasks due in 3 days âœ…
  - Personalized per resource âœ…

- [x] **Project At Risk Alerts**
  - WF-019: Project At Risk Alert âœ…
  - Triggered when completion < 70% âœ…
  - Email to stakeholders âœ…

- [x] **Validation Failure Notifications**
  - WF-020: Validation Failure Notification âœ…
  - Email to user with error details âœ…

### Scheduled Jobs

- [x] **Daily Resource Utilization Check**
  - WF-009: Runs daily at 9 AM âœ…
  - Checks all active resources âœ…
  - Triggers alerts if needed âœ…

- [x] **Weekly Project Health Report**
  - WF-010: Runs Monday at 8 AM âœ…
  - Generates Excel + PDF reports âœ…
  - Emails to management âœ…

- [x] **Daily Deadline Reminders**
  - WF-011: Runs daily at 8 AM âœ…
  - Finds tasks due in 3 days âœ…
  - Sends personalized reminders âœ…

- [x] **Nightly Database Maintenance**
  - WF-012: Runs daily at 2 AM âœ…
  - Cleans old audit logs âœ…
  - Refreshes materialized views (if used) âœ…

### Security

- [x] **Webhook Authentication**
  - API Key header validation âœ…
  - HMAC signature support âœ…
  - JWT token support âœ…

- [x] **IP Allowlist** (Optional)
  - Configurable via Nginx/Cloudflare âœ…

- [x] **Rate Limiting**
  - 100 requests per minute per client âœ…

- [x] **Input Sanitization**
  - XSS prevention âœ…
  - SQL injection prevention (parameterized queries) âœ…

- [x] **Secrets Management**
  - n8n credentials store âœ…
  - No hardcoded secrets âœ…

- [x] **HTTPS Only**
  - SSL/TLS required âœ…

- [x] **Audit Logging for Security Events**
  - Failed authentication logged âœ…
  - Suspicious activity tracked âœ…

### Error Handling

- [x] **Validation Errors Return 400**
  - Clear error messages âœ…
  - No retry needed âœ…

- [x] **Database Errors Retry**
  - Max 3 retries with exponential backoff âœ…

- [x] **External Service Errors Retry**
  - Max 5 retries with exponential backoff âœ…
  - Gracefully degrade if non-critical âœ…

- [x] **Global Error Handler**
  - Logs all errors âœ…
  - Sends alerts for critical errors âœ…

---

## ğŸ“Œ SUMMARY

This n8n workflow architecture provides:

### âœ… **26 Total Workflows**
- 8 CRUD workflows for REST API operations
- 4 scheduled automation workflows
- 4 reporting workflows with multiple output formats
- 4 notification workflows for alerts
- 6 reusable sub-workflows for common operations

### âœ… **Complete Business Logic Coverage**
- All Phase-0 business rules enforced
- Status transition state machine
- Resource capacity checks with warnings
- Foreign key validation
- Input validation with clear error messages

### âœ… **Comprehensive Audit Trail**
- Every mutation logged to audit_log table
- Before/after states captured in JSONB
- Changed fields tracked
- User attribution

### âœ… **Production-Ready Reporting**
- Excel, PDF, and CSV export formats
- Google Drive and S3 storage support
- Downloadable links returned
- Email delivery with attachments
- Scheduled weekly reports

### âœ… **Robust Error Handling**
- Retry strategies with exponential backoff
- Graceful degradation for non-critical services
- Global error handler workflow
- Security event logging

### âœ… **Enterprise Security**
- Multiple authentication methods (API Key, HMAC, JWT)
- IP allowlisting support
- Rate limiting
- Input sanitization
- HTTPS enforcement
- Secrets management via n8n credentials

### âœ… **Real-World Example Configurations**
- Complete node configurations with JSON
- Example payloads for all CRUD operations
- Function node pseudo-code for validation
- Database query examples with parameterization
- Email templates with HTML
- Slack block formatting

This architecture is ready for implementation in n8n and provides a complete automation layer for the QC Scenario Planning system.
