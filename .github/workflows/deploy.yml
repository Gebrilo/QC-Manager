name: Build and Deploy to Hostinger VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  API_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/qc-api
  WEB_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/qc-web

jobs:
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.API_IMAGE }}:latest
            ${{ env.API_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

  build-web:
    name: Build Web Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.WEB_IMAGE }}:latest
            ${{ env.WEB_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=web
          cache-to: type=gha,mode=max,scope=web
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

  deploy:
    name: Deploy to Hostinger VPS
    runs-on: ubuntu-latest
    needs: [build-api, build-web]

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          envs: DOCKER_HUB_USERNAME,DOCKER_HUB_TOKEN,JWT_SECRET,POSTGRES_PASSWORD,N8N_BASIC_AUTH_PASSWORD
          script_stop: true
          script: |
            set -euo pipefail

            DEPLOY_DIR="/opt/qc-manager"
            REPO_URL="https://github.com/Gebrilo/QC-Manager.git"

            echo "=== Checking deployment directory ==="
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Directory does not exist. Cloning repository..."
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown $USER:$USER "$DEPLOY_DIR"
              git clone "$REPO_URL" "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Creating .env file ==="
            cat > .env << EOF
            DOCKER_HUB_USERNAME=$DOCKER_HUB_USERNAME
            JWT_SECRET=$JWT_SECRET
            POSTGRES_USER=admin
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-Wind@123}
            POSTGRES_DB=postgres
            N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-admin}
            EOF

            echo "=== Docker login ==="
            echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

            echo "=== Creating proxy network (if not exists) ==="
            docker network create proxy 2>/dev/null || true

            echo "=== Starting reverse proxy ==="
            cd "$DEPLOY_DIR/reverse-proxy"
            docker compose up -d

            echo "=== Pulling app images ==="
            cd "$DEPLOY_DIR"
            docker compose -f docker-compose.prod.yml pull

            echo "=== Deploying app containers ==="
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            echo "=== Cleanup ==="
            docker image prune -f

            echo "=== Deployment complete ==="
            docker compose -f docker-compose.prod.yml ps
            echo ""
            echo "=== Reverse proxy status ==="
            cd "$DEPLOY_DIR/reverse-proxy"
            docker compose ps
