name: Build and Deploy to VPS

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  API_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/qc-api
  WEB_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/qc-web

jobs:
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.API_IMAGE }}:latest
            ${{ env.API_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

  build-web:
    name: Build Web Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.WEB_IMAGE }}:latest
            ${{ env.WEB_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=web
          cache-to: type=gha,mode=max,scope=web
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

  # ===========================================================================
  # PRODUCTION DEPLOY (main branch)
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-api, build-web]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          WEB_DOMAIN: ${{ secrets.WEB_DOMAIN }}
          API_DOMAIN: ${{ secrets.API_DOMAIN }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          envs: DOCKER_HUB_USERNAME,DOCKER_HUB_TOKEN,JWT_SECRET,POSTGRES_PASSWORD,N8N_WEBHOOK_URL,WEB_DOMAIN,API_DOMAIN,CORS_ORIGIN
          script_stop: true
          script: |
            set -euo pipefail

            DEPLOY_DIR="/opt/qc-manager"
            REPO_URL="https://github.com/Gebrilo/QC-Manager.git"

            echo "=== Checking deployment directory ==="
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown $USER:$USER "$DEPLOY_DIR"
              git clone "$REPO_URL" "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Ensuring shared network exists ==="
            docker network create qc-shared-network 2>/dev/null || true

            echo "=== Ensuring backup directory exists ==="
            mkdir -p "$DEPLOY_DIR/backups"

            echo "=== Writing .env ==="
            cat > .env << ENVEOF
            DOCKER_HUB_USERNAME=${DOCKER_HUB_USERNAME}
            WEB_DOMAIN=${WEB_DOMAIN}
            API_DOMAIN=${API_DOMAIN}
            POSTGRES_USER=qc_admin
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_DB=qc_app
            JWT_SECRET=${JWT_SECRET}
            CORS_ORIGIN=${CORS_ORIGIN}
            N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}
            BACKUP_PATH=./backups
            BACKUP_RETENTION_DAYS=7
            ENVEOF
            sed -i 's/^            //' .env

            echo "=== Docker login ==="
            echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

            echo "=== Pulling app images ==="
            docker compose -f docker-compose.prod.yml pull

            echo "=== Deploying ==="
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            echo "=== Cleanup ==="
            docker image prune -f

            echo "=== Deployment complete ==="
            docker compose -f docker-compose.prod.yml ps

  # ===========================================================================
  # STAGING DEPLOY (develop branch)
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-api, build-web]
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Deploy Staging to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
          JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
          POSTGRES_PASSWORD: ${{ secrets.STAGING_POSTGRES_PASSWORD }}
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          WEB_DOMAIN: ${{ secrets.STAGING_WEB_DOMAIN }}
          API_DOMAIN: ${{ secrets.STAGING_API_DOMAIN }}
          CORS_ORIGIN: ${{ secrets.STAGING_CORS_ORIGIN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          envs: DOCKER_HUB_USERNAME,DOCKER_HUB_TOKEN,JWT_SECRET,POSTGRES_PASSWORD,N8N_WEBHOOK_URL,WEB_DOMAIN,API_DOMAIN,CORS_ORIGIN
          script_stop: true
          script: |
            set -euo pipefail

            DEPLOY_DIR="/opt/qc-manager"
            REPO_URL="https://github.com/Gebrilo/QC-Manager.git"

            echo "=== Checking deployment directory ==="
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              sudo mkdir -p "$DEPLOY_DIR"
              sudo chown $USER:$USER "$DEPLOY_DIR"
              git clone "$REPO_URL" "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"

            echo "=== Pulling latest code ==="
            git fetch origin develop
            git reset --hard origin/develop

            echo "=== Ensuring shared network exists ==="
            docker network create qc-shared-network 2>/dev/null || true

            echo "=== Ensuring backup directory exists ==="
            mkdir -p "$DEPLOY_DIR/backups-staging"

            echo "=== Writing .env.staging ==="
            cat > .env.staging << ENVEOF
            DOCKER_HUB_USERNAME=${DOCKER_HUB_USERNAME}
            WEB_DOMAIN=${WEB_DOMAIN}
            API_DOMAIN=${API_DOMAIN}
            POSTGRES_USER=qc_staging_admin
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_DB=qc_staging_app
            JWT_SECRET=${JWT_SECRET}
            CORS_ORIGIN=${CORS_ORIGIN}
            N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}
            BACKUP_PATH=./backups-staging
            BACKUP_RETENTION_DAYS=3
            ENVEOF
            sed -i 's/^            //' .env.staging

            echo "=== Docker login ==="
            echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

            echo "=== Pulling app images ==="
            docker compose -f docker-compose.staging.yml --env-file .env.staging pull

            echo "=== Deploying staging ==="
            docker compose -f docker-compose.staging.yml --env-file .env.staging up -d --force-recreate

            echo "=== Cleanup ==="
            docker image prune -f

            echo "=== Staging deployment complete ==="
            docker compose -f docker-compose.staging.yml --env-file .env.staging ps
